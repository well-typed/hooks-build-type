# Use cases for hooks

Rodrigo Mesquita (Well-Typed LLP)

Following the [survey](./survey.md) and development of the initial prototype, we wrote
[experimental patches for surveyed packages](https://gitlab.haskell.org/mpickering/hooks-setup-testing/-/tree/a664eb3cf456ad8e6e4f922406f1f904575339b5/patches)
to ensure that our design could accommodate their requirements.  This document
summarises how each of those packages uses hooks.

This work has been carried out by Well-Typed LLP thanks to investment from the Sovereign Tech Fund.


## List of packages

Agda-2.6.3:
- Post build hook to generate interface files using the agda executable
- Post copy/install hook to copy the agda interface files to the install dir
    (for each `.agda` file in the data files stanza of the package description,
    for which an `.agdai` was generated)

executable-hash-0.2.0.4:
- Pre-test hook to inject the executable hash into the test executable (the
    package provides an executable to inject a program's hash into its binary
    code and a template haskell expression that returns `Just` the injected binary
    hash or `Nothing` if the hash wasn't injected).
- Additionally, the package provides an example of a postBuild hook in the
    documentation, saying that you can have Cabal automatically inject the hash
    into your executable by invoking the `inject-hash` executable on the result of
    building in the post build stage.

hlibgit2-0.18.0.16:
- Pre-configure adds "git" to the known programs with `addKnownPrograms`
    (previously this was done with the hook `hookedPrograms`)

postgresql-libpq-0.10.0.0:
- Pre-configure hook to configure extra libdirs and include psql gotten from
    calling out to `pg_config`, when `flag(use-pkg-config)` is false.

cabal-doctest-1.0.9:
This library defines `SetupHooks` which can be re-used by packages using build-type: Hooks
- Pre conf hook for adding `Build_doctests` to the testsuite's autogenerated modules
- Pre build hook to generate the contents of `Build_doctests` module inside the given testsuite

ghc-paths-0.1.0.12:
This package only has a `SetupHooks` file which generates a module `GHC.Paths`
with knowledge of GHC's installation directories
- Pre build hook to create the `GHC.Paths` module with information gotten from
    searching for programs paths and certain directories in the installedPkgs,
    or e.g. by invoking `ghc --print-libdir`.

include-file-0.1.0.4:
Template Haskell functions to include files in the executable at compile time.
- Pre build hook where we generate a file with random integers to include in the
    testsuite and benchmarks executable.
- Note that we generate the file for the testsuite and benchmarks in the /pre-build/
    hook because it is needed to compile the testsuite and benchmarks (since
    this file is loaded at compile time into the executable)
- If we only needed these generated files at runtime, we could have used the
    /pre-test/ or /pre-bench/ hooks.

singletons-base-3.2:
- Pre build hook to generate a module `Build_singletons_base` for the testsuite, which includes the directory from which the tests are being run, ghc's
    path, and a set of ghc flags: mainly package database flags and for each
    package that is a transitive dependency of singletons, because, when the
    test is run, it invokes GHC to compile something and dump the splices.

configuration-tools-0.7.0:
- Pre build hook to generate a module with package information for each
    component of the cabal package. This package info can be used with the
    library in the command line interface of an application to support
    additional commands like --version or --license, automatically.

haskell-gi and reverse dependencies such as gi-glib, gi-gobject:
- Pre conf hook that disables optimisations and, for the main library,
    generates a module hiearchy from GObject instrospection data.

interpolatedstring-perl6-1.0.2:
- Post test hook to `runElfTests`, which essentially entails calling
    `runhaskell` on the testsuite module. To be fair, I don't understand why
    this is being done and no comment or commit explains it.

stack-2.13.1:
- Pre build hook to generate, for the stack main library component, a module
    that lists all the dependencies of stack (both library and executable),
    which is used in `Stack.BuildInfo` to be listed.

darcs-2.16.5:
- Pre build hook to generate the version info using a GHC script and generating a version module
- Post build hook to build the manpages
- Post copy/install hook to install the manpages

mysql-0.2.1:
- Pre conf hooks to add `mysql_config`(s) to known programs, which are then used
    to configure include dirs and extra libs and dirs.

entropy-0.4.1.10:
- Pre conf hook, for the main library, where we determine a few configuration
    checks on random vs entropy vs RDAND to decide how to augment CPP options.

nix-paths-1.0.1:
- Pre conf hook to add a few nix-programs (e.g. `nix-hash`) to known programs,
    and to augment CPP options with path to these configured programs.


localPkgDescr warnings will all be gone, because the localPkgDescr will be fixed
after configure stage, and re-used all acrosss.
We can export a package to wrap absoluteInstallDirs, to be less scary.

